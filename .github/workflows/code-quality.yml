name: Code Quality

on:
  pull_request:
    branches: [ main ]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check commit messages
        run: |
          # Check if commitlint is available and run it on the PR commits
          if command -v npx >/dev/null 2>&1; then
            # Get the base commit and current commit
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"

            # Run commitlint on all commits in the PR
            npx commitlint --from="$BASE_SHA" --to="$HEAD_SHA" --verbose
          fi

      - name: Check TypeScript types
        run: npx astro check

      - name: Run ESLint
        run: npm run lint:eslint

      - name: Check Prettier formatting
        run: npm run lint:prettier

      - name: Check for console.log statements
        run: |
          # Check for console.log statements in source files (excluding test files)
          if grep -r "console\.log" src/ --exclude-dir=node_modules --include="*.ts" --include="*.js" --include="*.astro"; then
            echo "âŒ Found console.log statements in source code. Please remove them before merging."
            exit 1
          else
            echo "âœ… No console.log statements found in source code."
          fi

      - name: Check for TODO/FIXME comments
        run: |
          # Find TODO and FIXME comments and list them
          TODO_COUNT=$(grep -r "TODO\|FIXME" src/ --exclude-dir=node_modules --include="*.ts" --include="*.js" --include="*.astro" | wc -l || echo "0")

          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "âš ï¸ Found $TODO_COUNT TODO/FIXME comments:"
            grep -r "TODO\|FIXME" src/ --exclude-dir=node_modules --include="*.ts" --include="*.js" --include="*.astro" || true
            echo ""
            echo "These are reminders for future improvements and don't block the PR."
          else
            echo "âœ… No TODO/FIXME comments found."
          fi

      - name: Check bundle size impact
        run: |
          # Build the project and check the dist size
          npm run build

          if [ -d "dist" ]; then
            DIST_SIZE=$(du -sh dist/ | cut -f1)
            echo "ðŸ“¦ Build output size: $DIST_SIZE"

            # Create a simple size report
            echo "## ðŸ“Š Bundle Size Report" >> $GITHUB_STEP_SUMMARY
            echo "- **Total build size**: $DIST_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- **Files created**: $(find dist -type f | wc -l)" >> $GITHUB_STEP_SUMMARY

            # List largest files
            echo "### Largest files:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            find dist -type f -exec du -h {} + | sort -hr | head -10 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  accessibility-check:
    name: Accessibility Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Start preview server
        run: npm run preview &

      - name: Wait for server to be ready
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:4321; do sleep 1; done'

      - name: Install accessibility testing tools
        run: npm install -g @axe-core/cli

      - name: Run accessibility tests
        run: |
          # Test main pages for accessibility issues
          echo "Testing homepage for accessibility..."
          axe http://localhost:4321 --exit || echo "Accessibility issues found on homepage"

          echo "Testing about page for accessibility..."
          axe http://localhost:4321/about --exit || echo "Accessibility issues found on about page"

          echo "Testing blog page for accessibility..."
          axe http://localhost:4321/blog --exit || echo "Accessibility issues found on blog page"
